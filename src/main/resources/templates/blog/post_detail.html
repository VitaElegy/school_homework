<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: common_head(${post.title})}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <!-- Highlight.js Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <!-- Custom Styles for TOC and Layout -->
    <style>
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Sticky TOC Sidebar */
        .toc-sidebar {
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            padding-left: 15px;
            border-left: 2px solid #e9ecef;
            scrollbar-width: thin; /* Firefox */
        }

        /* Webkit scrollbar styling */
        .toc-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .toc-sidebar::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }

        .toc-link {
            display: block;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 6px;
            transition: all 0.2s;
            padding-left: 10px;
            border-left: 2px solid transparent;
            margin-left: -17px; /* Align with sidebar border */
            line-height: 1.4;
        }

        .toc-link:hover {
            color: #667eea;
            text-decoration: none;
        }

        .toc-link.active {
            color: #667eea;
            font-weight: 600;
            border-left-color: #667eea;
        }

        /* Indentation for H1-H5 */
        .toc-h1 { margin-left: -17px; font-weight: 700; font-size: 1rem; margin-top: 15px; }
        .toc-h2 { margin-left: -5px; }
        .toc-h3 { margin-left: 10px; font-size: 0.85rem; }
        .toc-h4 { margin-left: 25px; font-size: 0.8rem; color: #a0aec0; }
        .toc-h5 { margin-left: 40px; font-size: 0.75rem; color: #a0aec0; }

        /* Dynamic visibility logic */
        /* By default, hide H4 and H5 */
        .toc-h4, .toc-h5 {
            display: none;
            height: 0;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, height 0.3s ease;
            margin-bottom: 0;
        }

        /* Reveal logic:
           If an H3 parent is active, or if the H4/H5 itself is active, show it.
           We'll handle the 'expanded' class via JS for easier state management.
        */
        .toc-item.expanded > .toc-h4,
        .toc-item.expanded > .toc-h5,
        .toc-link.active + .toc-subgroup .toc-h4, /* Basic idea, but structure is flat list currently */
        .toc-h4.visible, .toc-h5.visible {
            display: block;
            height: auto;
            opacity: 1;
            margin-bottom: 6px;
        }

        /* Hide TOC on small screens */
        @media (max-width: 991.98px) {
            .toc-container {
                display: none;
            }
        }
    </style>

    <!-- Breadcrumb / Back -->
    <div class="mb-4">
        <a href="/blog" class="text-muted text-decoration-none">
            <i class="fas fa-arrow-left mr-1"></i> Back to Posts
        </a>
    </div>

    <div class="row">
        <!-- Main Content Column -->
        <div class="col-lg-9">
            <!-- Main Post Card -->
            <div class="card shadow-lg mb-5 border-0">
                <div class="card-body p-5">
                    <h1 class="card-title display-4 font-weight-bold mb-3" th:text="${post.title}">Title</h1>

                    <div class="d-flex align-items-center mb-4 text-muted post-meta">
                        <span class="mr-3 d-flex align-items-center">
                            <img th:if="${post.author.avatar != null}" th:src="@{'/uploads/avatars/' + ${post.author.avatar}}" class="rounded-circle mr-2" width="30" height="30" style="object-fit: cover;">
                            <i th:if="${post.author.avatar == null}" class="fas fa-user-circle mr-2"></i>
                            <span th:text="${post.author.username}">Author</span>
                        </span>
                        <span class="mr-3"><i class="far fa-calendar-alt mr-1"></i> <span th:text="${#temporals.format(post.createdAt, 'MMM d, yyyy HH:mm')}">Date</span></span>
                        <span><i class="far fa-eye mr-1"></i> <span th:text="${post.viewCount}">0</span> Views</span>
                    </div>

                    <div class="mb-4">
                        <span th:each="tag : ${post.tags}" class="badge badge-light border mr-2 p-2">
                            <i class="fas fa-tag text-muted mr-1"></i>
                            <a th:href="@{/blog(tag=${tag.name})}" th:text="${tag.name}" class="text-secondary text-decoration-none">Tag</a>
                        </span>
                    </div>

                    <hr class="my-4">

                    <!-- Content with ID for JS selection -->
                    <div id="post-content" class="post-content markdown-body" th:utext="${htmlContent}">
                        Content placeholder...
                    </div>
                </div>

                <!-- Author Actions -->
                <div class="card-footer bg-white border-top-0 d-flex justify-content-end pb-4" th:if="${#authentication.name == post.author.username}">
                     <a th:href="@{/blog/posts/{id}/edit(id=${post.id})}" class="btn btn-outline-primary mr-2">
                         <i class="fas fa-edit mr-1"></i> Edit
                     </a>
                    <form th:action="@{/blog/posts/{id}/delete(id=${post.id})}" method="post"
                          onsubmit="return confirm('Are you sure you want to delete this post?');" style="display:inline;">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt mr-1"></i> Delete
                        </button>
                    </form>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-body p-4">
                    <h4 class="font-weight-bold mb-4">Comments</h4>
                    <!-- Add Comment Form -->
                    <div sec:authorize="isAuthenticated()" class="mb-4">
                        <form th:action="@{/blog/posts/{postId}/comments(postId=${post.id})}" method="post" th:object="${newComment}">
                            <div class="form-group">
                                <textarea class="form-control" rows="3" placeholder="Join the discussion..." th:field="*{content}" required></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm mt-2">Post Comment</button>
                        </form>
                    </div>
                    <div sec:authorize="!isAuthenticated()" class="alert alert-light text-center mb-4">
                        <a href="/login">Login</a> to leave a comment.
                    </div>

                    <!-- Comment List -->
                    <div th:each="comment : ${post.comments}" class="media mb-4 comment-card p-3 rounded">
                        <img th:if="${comment.author.avatar != null}" th:src="@{'/uploads/avatars/' + ${comment.author.avatar}}" class="d-flex mr-3 rounded-circle" width="50" height="50" style="object-fit: cover;">
                        <i th:if="${comment.author.avatar == null}" class="fas fa-user-circle d-flex mr-3 text-secondary" style="font-size: 50px;"></i>

                        <div class="media-body">
                            <h6 class="mt-0 font-weight-bold" th:text="${comment.author.username}">User</h6>
                            <small class="text-muted d-block mb-2" th:text="${#temporals.format(comment.createdAt, 'MMM d, yyyy HH:mm')}">Date</small>
                            <p class="mb-0" th:text="${comment.content}">Comment content...</p>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(post.comments)}" class="text-center text-muted py-3">
                        No comments yet. Be the first to share your thoughts!
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Column for TOC -->
        <div class="col-lg-3 toc-container">
            <div class="toc-sidebar">
                <h6 class="font-weight-bold text-uppercase text-muted mb-3 small" style="letter-spacing: 1px;">Table of Contents</h6>
                <div id="toc-content">
                    <!-- TOC items will be generated here by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
    // Initialize Highlight.js
    hljs.highlightAll();

    // Generate TOC
    document.addEventListener('DOMContentLoaded', function() {
        const content = document.getElementById('post-content');
        const tocContainer = document.getElementById('toc-content');
        // Select H1 through H5
        const headers = Array.from(content.querySelectorAll('h1, h2, h3, h4, h5'));

        if (headers.length === 0) {
            tocContainer.innerHTML = '<p class="text-muted small">No headers found.</p>';
            return;
        }

        const headerMap = []; // Store mapping to easily find parent/child relationships if needed

        headers.forEach((header, index) => {
            if (!header.id) {
                header.id = 'header-' + index;
            }

            const tagName = header.tagName.toLowerCase();
            const level = parseInt(tagName.replace('h', ''));

            const link = document.createElement('a');
            link.href = '#' + header.id;
            link.className = `toc-link toc-${tagName}`;
            link.textContent = header.textContent;

            // For H4 and H5, add specific data attribute to identify them
            if (level >= 4) {
                link.dataset.level = level;
            }

            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById(header.id).scrollIntoView({
                    behavior: 'smooth'
                });
            });

            // Store ref for scroll spy
            headerMap.push({
                header: header,
                link: link,
                level: level
            });

            tocContainer.appendChild(link);
        });

        // Scroll Spy Logic with Dynamic Expansion
        window.addEventListener('scroll', function() {
            let fromTop = window.scrollY + 150;
            let activeIndex = -1;

            // Find current active header
            for (let i = 0; i < headerMap.length; i++) {
                if (headerMap[i].header.offsetTop <= fromTop) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            // Reset all active states
            headerMap.forEach(item => item.link.classList.remove('active'));

            // Reset all visibility for H4/H5 (collapse all first)
            headerMap.forEach(item => {
                if (item.level >= 4) {
                    item.link.classList.remove('visible');
                }
            });

            if (activeIndex !== -1) {
                const activeItem = headerMap[activeIndex];
                activeItem.link.classList.add('active');

                // Logic:
                // 1. If active item is H1, H2, H3 -> Expand their immediate H4 children (if any, until next H1-H3)
                // 2. If active item is H3 -> Also expand H4, H5 children?
                // The requirement: "Display H1-H3 normally. When scrolling to H3, expand H4-H5."

                // Let's implement a look-ahead logic:
                // Find the range of headers that belong to the current "section".

                // We need to identify which H3 is currently "active" or "parent of active".
                // We look backwards from activeIndex to find the nearest H3 (or H1/H2 if we want to reset).

                let currentH3Index = -1;

                // If current active is >= H3, find the H3 it belongs to
                for (let i = activeIndex; i >= 0; i--) {
                    if (headerMap[i].level === 3) {
                        currentH3Index = i;
                        break;
                    }
                    if (headerMap[i].level < 3) {
                        break; // Stop if we hit H1 or H2, meaning we are not inside an H3 block
                    }
                }

                if (currentH3Index !== -1) {
                    // We are inside an H3 block. Expand all H4 and H5 that are children of this H3.
                    // Loop forward from currentH3Index + 1 until we hit a level <= 3
                    for (let i = currentH3Index + 1; i < headerMap.length; i++) {
                        if (headerMap[i].level <= 3) {
                            break;
                        }
                        // This is an H4 or H5 child of the current H3
                        headerMap[i].link.classList.add('visible');
                    }
                }
            }
        });
    });
</script>
</body>
</html>
